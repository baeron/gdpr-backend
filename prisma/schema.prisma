// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Audit request from the landing page form
model AuditRequest {
  id              String   @id @default(cuid())
  websiteUrl      String
  email           String
  agreeScan       Boolean  @default(true)
  agreeMarketing  Boolean  @default(false)
  locale          String   @default("en")
  status          AuditStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  auditReport     AuditReport?

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// Audit report generated after scanning
model AuditReport {
  id              String   @id @default(cuid())
  auditRequestId  String?  @unique
  auditRequest    AuditRequest? @relation(fields: [auditRequestId], references: [id], onDelete: Cascade)
  
  // Basic info
  websiteUrl      String
  scanDurationMs  Int?
  
  // Scores
  overallScore    Int?     // 0-100
  riskLevel       RiskLevel @default(UNKNOWN)
  
  // Scan results (stored as JSON for flexibility)
  cookies         Json?    // { total, beforeConsent, list: CookieInfo[] }
  trackers        Json?    // { total, beforeConsent, list: TrackerInfo[] }
  thirdPartyRequests Json? // { total, beforeConsent, list: ThirdPartyRequest[] }
  consentBanner   Json?    // ConsentBannerInfo
  privacyPolicy   Json?    // PrivacyPolicyInfo
  security        Json?    // SecurityInfo
  forms           Json?    // FormsAnalysisResult
  dataTransfers   Json?    // DataTransferInfo
  technologies    Json?    // TechnologyDetectionResult
  
  // Issues (separate table for querying)
  issues          ScanIssue[]
  
  scannedAt       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([websiteUrl])
  @@index([riskLevel])
  @@index([scannedAt])
}

// Individual scan issues for detailed reporting
model ScanIssue {
  id              String   @id @default(cuid())
  auditReportId   String
  auditReport     AuditReport @relation(fields: [auditReportId], references: [id], onDelete: Cascade)
  
  // Issue identification
  code            String   // e.g., "COOKIES_BEFORE_CONSENT"
  category        IssueCategory
  
  // Issue details
  title           String
  description     String   @db.Text
  riskLevel       RiskLevel
  
  // Evidence and recommendations
  evidence        String?  @db.Text  // Specific proof (cookie names, URLs, etc.)
  recommendation  String   @db.Text
  codeExample     String?  @db.Text  // Implementation example
  
  // Effort estimation
  effortHours     String?  // e.g., "2-4"
  estimatedCost   String?  // e.g., "â‚¬150-300"
  
  // Status tracking
  status          IssueStatus @default(OPEN)
  resolvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([auditReportId])
  @@index([category])
  @@index([riskLevel])
  @@index([status])
}

enum IssueCategory {
  COOKIES
  TRACKERS
  CONSENT
  PRIVACY_POLICY
  SECURITY
  FORMS
  DATA_TRANSFER
  TECHNOLOGY
  OTHER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  WONT_FIX
}

// Scan job queue for async processing
model ScanJob {
  id              String    @id @default(cuid())
  websiteUrl      String
  auditRequestId  String?
  
  // Job status
  status          ScanJobStatus @default(QUEUED)
  priority        Int       @default(0)  // Higher = more priority
  
  // Progress tracking
  progress        Int       @default(0)  // 0-100
  currentStep     String?   // e.g., "Analyzing cookies..."
  
  // Results
  reportId        String?   // Link to AuditReport when completed
  error           String?   // Error message if failed
  
  // Timing
  queuedAt        DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Metadata
  userEmail       String?
  locale          String    @default("en")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([queuedAt])
  @@index([priority, queuedAt])
}

enum ScanJobStatus {
  QUEUED      // Waiting in queue
  PROCESSING  // Currently scanning
  COMPLETED   // Scan finished successfully
  FAILED      // Scan failed with error
  CANCELLED   // User cancelled
}

enum AuditStatus {
  PENDING      // Just submitted
  PROCESSING   // Scan in progress
  COMPLETED    // Report ready
  FAILED       // Scan failed
  CANCELLED    // User cancelled
}

enum RiskLevel {
  UNKNOWN
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
