// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Audit request from the landing page form
model AuditRequest {
  id              String   @id @default(cuid())
  websiteUrl      String
  email           String
  agreeScan       Boolean  @default(true)
  agreeMarketing  Boolean  @default(false)
  locale          String   @default("en")
  status          AuditStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  auditReport     AuditReport?

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// Audit report generated after scanning
model AuditReport {
  id              String   @id @default(cuid())
  auditRequestId  String?  @unique
  auditRequest    AuditRequest? @relation(fields: [auditRequestId], references: [id], onDelete: Cascade)
  
  // Basic info
  websiteUrl      String
  scanDurationMs  Int?
  
  // Scores
  overallScore    Int?     // 0-100
  riskLevel       RiskLevel @default(UNKNOWN)
  
  // Scan results (stored as JSON for flexibility)
  cookies         Json?    // { total, beforeConsent, list: CookieInfo[] }
  trackers        Json?    // { total, beforeConsent, list: TrackerInfo[] }
  thirdPartyRequests Json? // { total, beforeConsent, list: ThirdPartyRequest[] }
  consentBanner   Json?    // ConsentBannerInfo
  privacyPolicy   Json?    // PrivacyPolicyInfo
  security        Json?    // SecurityInfo
  forms           Json?    // FormsAnalysisResult
  dataTransfers   Json?    // DataTransferInfo
  technologies    Json?    // TechnologyDetectionResult
  
  // Issues (separate table for querying)
  issues          ScanIssue[]
  
  // Payment/access control
  fullReportUnlocked Boolean @default(false)
  
  scannedAt       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([websiteUrl])
  @@index([riskLevel])
  @@index([scannedAt])
}

// Individual scan issues for detailed reporting
model ScanIssue {
  id              String   @id @default(cuid())
  auditReportId   String
  auditReport     AuditReport @relation(fields: [auditReportId], references: [id], onDelete: Cascade)
  
  // Issue identification
  code            String   // e.g., "COOKIES_BEFORE_CONSENT"
  category        IssueCategory
  
  // Issue details
  title           String
  description     String   @db.Text
  riskLevel       RiskLevel
  
  // Evidence and recommendations
  evidence        String?  @db.Text  // Specific proof (cookie names, URLs, etc.)
  recommendation  String   @db.Text
  codeExample     String?  @db.Text  // Implementation example
  
  // Effort estimation
  effortHours     String?  // e.g., "2-4"
  estimatedCost   String?  // e.g., "€150-300"
  
  // Status tracking
  status          IssueStatus @default(OPEN)
  resolvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([auditReportId])
  @@index([category])
  @@index([riskLevel])
  @@index([status])
}

enum IssueCategory {
  COOKIES
  TRACKERS
  CONSENT
  PRIVACY_POLICY
  SECURITY
  FORMS
  DATA_TRANSFER
  TECHNOLOGY
  OTHER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  WONT_FIX
}

// Scan job queue for async processing
model ScanJob {
  id              String    @id @default(cuid())
  websiteUrl      String
  auditRequestId  String?
  
  // Job status
  status          ScanJobStatus @default(QUEUED)
  priority        Int       @default(0)  // Higher = more priority
  
  // Progress tracking
  progress        Int       @default(0)  // 0-100
  currentStep     String?   // e.g., "Analyzing cookies..."
  
  // Results
  reportId        String?   // Link to AuditReport when completed
  error           String?   // Error message if failed
  
  // Timing
  queuedAt        DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Metadata
  userEmail       String?
  locale          String    @default("en")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([queuedAt])
  @@index([priority, queuedAt])
}

enum ScanJobStatus {
  QUEUED      // Waiting in queue
  PROCESSING  // Currently scanning
  COMPLETED   // Scan finished successfully
  FAILED      // Scan failed with error
  CANCELLED   // User cancelled
}

enum AuditStatus {
  PENDING      // Just submitted
  PROCESSING   // Scan in progress
  COMPLETED    // Report ready
  FAILED       // Scan failed
  CANCELLED    // User cancelled
}

enum RiskLevel {
  UNKNOWN
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Payment for full report access
model Payment {
  id                    String        @id @default(cuid())
  reportId              String
  
  // Stripe data
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?
  
  // Amount
  amount                Int           // in cents
  currency              String        @default("eur")
  
  // A/B test tracking
  priceVariant          String?       // 'A' or 'B'
  
  // Status
  status                PaymentStatus @default(PENDING)
  
  // User info
  userEmail             String?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  @@index([reportId])
  @@index([stripeSessionId])
  @@index([status])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
  REFUNDED
}

// ==================== ANALYTICS ====================

// Analytics session — one per visitor session
model AnalyticsSession {
  id                String   @id @default(cuid())
  sessionId         String   @unique  // UUID generated on client (sessionStorage)

  // GeoIP (resolved server-side from IP)
  ipHash            String?  // SHA-256 hash of IP + daily salt (GDPR)
  country           String?  // ISO 3166-1 alpha-2 (e.g., "DE", "FR")
  city              String?
  region            String?
  timezone          String?  // e.g., "Europe/Berlin"

  // Device info (parsed from User-Agent)
  browser           String?  // e.g., "Chrome"
  browserVersion    String?  // e.g., "120.0"
  os                String?  // e.g., "Windows"
  osVersion         String?  // e.g., "11"
  deviceType        DeviceType @default(DESKTOP)

  // Traffic source
  referrer          String?  // document.referrer
  utmSource         String?  // utm_source
  utmMedium         String?  // utm_medium
  utmCampaign       String?  // utm_campaign
  utmTerm           String?  // utm_term
  utmContent        String?  // utm_content

  // Landing context
  landingPage       String?  // first page URL path
  language          String?  // navigator.language (e.g., "de", "en-US")
  screenResolution  String?  // e.g., "1920x1080"
  viewportSize      String?  // e.g., "1440x900"

  // Timing
  lastActivityAt    DateTime @default(now())
  createdAt         DateTime @default(now())

  // Relations
  events            AnalyticsEvent[]

  @@index([sessionId])
  @@index([country])
  @@index([utmSource])
  @@index([utmCampaign])
  @@index([createdAt])
  @@index([deviceType])
  @@index([landingPage])
}

// Analytics event — many per session
model AnalyticsEvent {
  id                String   @id @default(cuid())
  sessionId         String
  session           AnalyticsSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Event data
  eventType         AnalyticsEventType
  page              String?  // URL path where event occurred
  
  // Element context (for clicks, form interactions)
  elementId         String?  // e.g., "agreeScan", "url", "email"
  elementType       String?  // e.g., "checkbox", "input", "button"
  
  // Flexible payload (event-specific data)
  metadata          Json?    // { questionIndex: 3, scrollPercent: 75, ... }

  // Timing
  timestamp         DateTime @default(now())

  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@index([eventType, timestamp])
  @@index([page])
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
  UNKNOWN
}

enum AnalyticsEventType {
  // Navigation
  PAGE_VIEW
  SCROLL_DEPTH
  SECTION_VIEW

  // Form interactions (hero form)
  FORM_FOCUS
  FORM_INPUT
  FORM_ERROR
  FORM_SUBMIT
  CHECKBOX_TOGGLE

  // CTA & pricing
  CTA_CLICK
  PRICING_CARD_CLICK

  // Scan lifecycle
  SCAN_STARTED
  SCAN_COMPLETED
  SCAN_FAILED
  SCAN_PHASE_SEEN

  // Payment flow
  CHECKOUT_STARTED
  CHECKOUT_REDIRECT
  PAYMENT_VERIFIED

  // Report interactions
  REPORT_VIEW
  REPORT_CATEGORY_EXPAND
  REPORT_ISSUE_EXPAND
  DOWNLOAD_PDF

  // Consent banner
  CONSENT_ACCEPT
  CONSENT_REJECT
  CONSENT_CUSTOM

  // UI interactions
  LANGUAGE_SWITCH
  LANGUAGE_DROPDOWN_OPEN
  FAQ_EXPAND

  // Errors & session
  ERROR_SHOWN
  SESSION_END
}
