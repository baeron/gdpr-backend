# Azure Pipelines CI/CD for NestJS Backend
# GDPR Audit Backend API

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '*.md'
      - '.github/**'

pr:
  branches:
    include:
      - main

variables:
  nodeVersion: '20.x'
  npmCacheFolder: $(Pipeline.Workspace)/.npm

stages:
  # ============================================
  # Stage 1: Build & Test
  # ============================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      # Lint job
      - job: Lint
        displayName: 'Lint'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: |
              npm ci --cache $(npmCacheFolder)
              chmod -R +x node_modules/.bin
            displayName: 'Install dependencies'

          - script: npx prisma generate
            displayName: 'Generate Prisma client'

          - script: npm run lint
            displayName: 'Run ESLint'

      # Format check job
      - job: Format
        displayName: 'Format Check'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: |
              npm ci --cache $(npmCacheFolder)
              chmod -R +x node_modules/.bin
            displayName: 'Install dependencies'

          - script: npx prisma generate
            displayName: 'Generate Prisma client'

          - script: npx prettier --check "src/**/*.ts" "test/**/*.ts"
            displayName: 'Check code formatting'

      # Unit Tests job
      - job: Test
        displayName: 'Unit Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: |
              npm ci --cache $(npmCacheFolder)
              chmod -R +x node_modules/.bin
            displayName: 'Install dependencies'

          - script: npx prisma generate
            displayName: 'Generate Prisma client'

          - script: npm run test:cov
            displayName: 'Run unit tests with coverage'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
            condition: succeededOrFailed()

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

      # Build job
      - job: BuildApp
        displayName: 'Build Application'
        dependsOn:
          - Lint
          - Format
          - Test
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: |
              npm ci --cache $(npmCacheFolder)
              chmod -R +x node_modules/.bin
            displayName: 'Install dependencies'

          - script: npx prisma generate
            displayName: 'Generate Prisma client'

          - script: npm run build
            displayName: 'Build application'

          - publish: $(System.DefaultWorkingDirectory)/dist
            artifact: dist
            displayName: 'Publish build artifact'

      # E2E Tests job
      - job: E2E
        displayName: 'E2E Tests'
        dependsOn: BuildApp
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCacheFolder)

          - script: |
              npm ci --cache $(npmCacheFolder)
              chmod -R +x node_modules/.bin
            displayName: 'Install dependencies'

          - script: npx prisma generate
            displayName: 'Generate Prisma client'

          - download: current
            artifact: dist
            displayName: 'Download build artifact'

          - script: mv $(Pipeline.Workspace)/dist $(System.DefaultWorkingDirectory)/dist
            displayName: 'Restore dist artifact'

          - script: npm run test:e2e
            displayName: 'Run E2E tests'

  # ============================================
  # Stage 2: Deploy (only on main branch)
  # ============================================
  - stage: Deploy
    displayName: 'Deploy to Vultr'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      - group: vultr-deployment
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - script: |
                    # Setup SSH key
                    mkdir -p ~/.ssh
                    echo "$(VULTR_SSH_KEY)" | base64 -d > ~/.ssh/deploy_key
                    chmod 600 ~/.ssh/deploy_key
                    
                    # Add host to known_hosts
                    ssh-keyscan -H $(VULTR_HOST) >> ~/.ssh/known_hosts
                  displayName: 'Setup SSH Key'

                - script: |
                    # Copy project files to server
                    rsync -avz --delete \
                      --exclude 'node_modules' \
                      --exclude '.git' \
                      --exclude 'coverage' \
                      --exclude '.env' \
                      -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
                      ./ deploy@$(VULTR_HOST):/opt/gdpr-backend/
                  displayName: 'Copy files to server'

                - script: |
                    ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$(VULTR_HOST) << 'EOF'
                      cd /opt/gdpr-backend
                      
                      # Build and restart containers
                      docker-compose down
                      docker-compose build --no-cache
                      docker-compose up -d
                      
                      # Wait for health check
                      sleep 10
                      
                      # Verify deployment
                      curl -f http://localhost:3000/api/health || exit 1
                      
                      echo "Deployment successful!"
                    EOF
                  displayName: 'Deploy with Docker'

                - script: |
                    # Clean up old Docker images
                    ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@$(VULTR_HOST) << 'EOF'
                      docker image prune -f
                    EOF
                  displayName: 'Cleanup old images'
                  condition: succeeded()
