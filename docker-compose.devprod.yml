version: '3.8'

services:
  api-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gdpr-api-dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@gdpr-postgres:5432/${POSTGRES_DB}?schema=dev
      PORT: 3000
      RESEND_API_KEY: ${RESEND_API_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      QUEUE_TYPE: postgres
      WORKER_ENABLED: "true"
    ports:
      - "127.0.0.1:3001:3000"
    networks:
      - gdpr-backend_default
    command: >
      sh -c "
        npx prisma migrate deploy &&
        npm run start:prod
      "

networks:
  gdpr-backend_default:
    external: true
